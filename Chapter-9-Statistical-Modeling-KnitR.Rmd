---
title: "Ch. 9 Statistical Modeling and KnitR"
author: "Rose An, Michael Krzywicki"
date: "`r Sys.Date()`"
output: 
  bookdown::html_document2:
    toc: TRUE
    toc_float: TRUE
link-citations: yes
fontsize: 12pt
# bibliography: 
# csl: 
---
# Introduction
In this tutorial, we will learn how to set up a reproducible R Markdown document for statistical analysis/modeling. On Tuesday, we will ensure that everyone has downloaded the right data and packages, revisit chunk commands, and revisit inline coding. On Thursday, we will 

## Aim
We will learn how to dynamically connect data gathering and source code to markdown documents, setup pipeline to rerun analysis and present results whenever compiled, and keep markdown documents up to date and reflecting changes made to the data or analysis in source code files.

# Learning Outcomes
1. Identify the correct chunk commands to use in different situations.
2. Understand how to use inline code to dynamically report variables in your text.
3. Dynamically include locally sourced modular analysis
4. Dynamically include url-sourced modular analysis
5. Analyze data within a code chunk
6. Ensure results are reproducibly random
7. Understand caching.

# Data
Download data from google drive. This is a dataset of "encounter rates" calculated from eBird data, which are calculated from the percentage of checklists that include a particular species in a given area. This data has been generated for the United States, and Mike is getting ready to do encounter rates for species in Sonora, Mexico that are also found in Idaho. 

# Packages
Make sure you have the following packages: "knitr", "rmarkdown", "bookdown", "formattable", "kableExtra", "dplyr", "magrittr", "prettydoc", "htmltools", "knitcitations", "bibtex", "devtools", "tidyverse"
Not sure we'll actually need all this.

```{r packages, echo = TRUE, warning = FALSE, include = FALSE}
###~~~
# Load R packages
###~~~
#Create a vector w/ the required R packages
# --> If you have a new dependency, don't forget to add it in this vector
pkg <- c("knitr", "rmarkdown", "bookdown", "formattable", "kableExtra", "dplyr", "magrittr", "prettydoc", "htmltools", "knitcitations", "bibtex", "devtools", "tidyverse")

##~~~
#2. Check if pkg are already installed on your computer
##~~~
print("Check if packages are installed")
#This line below outputs a list of packages that are not installed. Which ones of the packages above are installed in computer, print packages that are not installed. Should print 0.
new.pkg <- pkg[!(pkg %in% installed.packages())]

##~~~
#3. Install missing packages
##~~~
# Use an if/else statement to check whether packages have to be installed
# WARNING: If your target R package is not deposited on CRAN then you need to adjust code/function
if(length(new.pkg) > 0){
  print(paste("Install missing package(s):", new.pkg, sep=' '))
  install.packages(new.pkg, dependencies = TRUE)
}else{
  print("All packages are already installed!")
}

##~~~
#4. Load all required packages
##~~~
print("Load packages and return status")
#Here we use the sapply() function to require all the packages
# To know more about the function type ?sapply() in R console
# Just an easier way to load all packages
sapply(pkg, require, character.only = TRUE)
# debug = right-pointing arrow next to code will load in console so you can go line by line and debug. pressing this also seemed to resolve the CRAN needs a mirror error
# Generate BibTex citation file for all loaded R packages
# used to produce report Notice the syntax used here to
# call the function
knitr::write_bib(.packages(), file = )
# The .packages() function returns invisibly the names of all packages loaded in the current R session (to see the output, use .packages(all.available = TRUE)). This ensures that all packages used in your code will have their citation entries written to the .bib file. This packages is then used in the Appendix to cite the code used
```

```{r setup, include = FALSE, cache = FALSE, }
### Load packages Add any packages specific to your code
library("knitr")
library("bookdown")
### Chunk options: see http://yihui.name/knitr/options/ ###
### Text output
opts_chunk$set(echo = TRUE, warning = TRUE, message = TRUE, include = TRUE)
## Code formatting
opts_chunk$set(tidy = TRUE, tidy.opts = list(blank = FALSE, width.cutoff = 60),
    highlight = TRUE)
## Code caching
opts_chunk$set(cache = 2, cache.path = "cache/")
## Plot output The first dev is the master for the output
## document
opts_chunk$set(fig.path = "Figures_MS/", dev = c("png", "pdf"),
    dpi = 300)
## Figure positioning
opts_chunk$set(fig.pos = "H")
```

# Identify the correct chunk commands to use in different situations.
Although dynamically linking source code to markdown documents is the main goal of this chapter, sometimes it makes sense to include short code chunks directly into your markdown document. There are a variety of customizable options on how the code and its output are display in the final knitted document.

What do the chunk commands do:

## Thought Excercise:
Take 5 minutes to discuss with the person sitting next to you. Given the same chunk of analysis, how would you set up your chunk commands when the document is being sent to your advisor for review versus being sent to a journal for publication?

# Understand how to use inline code to dynamically report variables in your text.

Sometimes you may want to have R code or output appear inline with the rest of the markdown document. These can be static or dynamic.

* Static: When you want to display a line of code in the markdown document.

 ** Example: Here is a line of code from data prep for this lesson: `ID_enc_rate <- state_enc_rate_clean_filtered %>%
  filter(encounter.state.normalized!=0
  )`

# Dynamically include locally sourced modular analysis

# Dynamically include url-sourced modular analysis

# Analyze data within a code chunk

# Ensure results are reproducibly random
Set.seed explanation
## Challenge:
You and the person next to you use the same distribution variables but diff vs. same set.seed. Do you get the same result? What about when you use the same set.seed? Insert set.seeds here.

# Understand caching.



# References

<div id="refs"></div>


# (APPENDIX) Appendices {-}

# Appendix 1

Citations of all R packages used to generate this report. Reads and prints citations stored in packages.bib
```{r generateBibliography, results = "asis", echo = FALSE, warning = FALSE, message = FALSE}
### Load R package
library("knitcitations")
### Process and print citations in packages.bib Clear all
### bibliography that could be in the cash
cleanbib()
# Set pandoc as the default output option for bib
options(citation_format = "pandoc")
# Read and print bib from file
# read.bibtex(file = )
```

# Appendix 2

Version information about R, the operating system (OS) and attached or R loaded packages. This appendix was generated using `sessionInfo()`.

```{r}
# Load and provide all packages and versions
sessionInfo()
```


